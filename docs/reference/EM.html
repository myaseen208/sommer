<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Expectation Maximization Algorithm — EM • sommer</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Expectation Maximization Algorithm — EM"><meta name="description" content="Univariate version of the expectation maximization (EM) algorithm."><meta property="og:description" content="Univariate version of the expectation maximization (EM) algorithm."><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116716530-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116716530-2');
</script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sommer</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">4.3.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span> Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-code"></span> Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-file-o"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes"><li><a class="dropdown-item" href="../articles/v1.sommer.quick.start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/v2.sommer.changes.and.faqs.html">FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/v3.sommer.qg.html">Quantitative Genetics</a></li>
    <li><a class="dropdown-item" href="../articles/v4.sommer.gxe.html">GxE models</a></li>
    <li><a class="dropdown-item" href="../articles/v5.sommer.vs.lme4.html">sommer vs lme4</a></li>
    <li><a class="dropdown-item" href="../articles/v6.sommer.spatial.html">Spatial</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="https://github.com/covaruber/sommer" aria-label="GitHub repository"><span class="fa fa-github"></span> GitHub</a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Expectation Maximization Algorithm</h1>

      <div class="d-none name"><code>EM.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Univariate version of the expectation maximization (EM) algorithm.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">EM</span><span class="op">(</span><span class="va">y</span>,X<span class="op">=</span><span class="cn">NULL</span>,ZETA<span class="op">=</span><span class="cn">NULL</span>,R<span class="op">=</span><span class="cn">NULL</span>,iters<span class="op">=</span><span class="fl">30</span>,draw<span class="op">=</span><span class="cn">TRUE</span>,silent<span class="op">=</span><span class="cn">FALSE</span>, </span>
<span>   constraint<span class="op">=</span><span class="cn">TRUE</span>, init<span class="op">=</span><span class="cn">NULL</span>, forced<span class="op">=</span><span class="cn">NULL</span>, tolpar <span class="op">=</span> <span class="fl">1e-04</span>, </span>
<span>   tolparinv <span class="op">=</span> <span class="fl">1e-06</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <p></p>
<dl><dt id="arg-y">y<a class="anchor" aria-label="anchor" href="#arg-y"></a></dt>
<dd><p>a numeric vector for the response variable</p></dd>

  <dt id="arg-x">X<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>an incidence matrix for fixed effects.</p></dd>

  <dt id="arg-zeta">ZETA<a class="anchor" aria-label="anchor" href="#arg-zeta"></a></dt>
<dd><p>an incidence matrix for random effects. This can be for one or more random effects. This NEEDS TO BE PROVIDED AS A LIST STRUCTURE. For example Z=list(list(Z=Z1, K=K1), list(Z=Z2, K=K2), list(Z=Z3, K=K3)) makes a 2 level list for 3 random effects. The general idea is that each random effect with or without its variance-covariance structure is a list, i.e. list(Z=Z1, K=K1) where Z is the incidence matrix and K the var-cov matrix. When moving to more than one random effect we need to make several lists that need to be inside another list. What we call a 2-level list, i.e. list(Z=Z1, K=K1) and list(Z=Z2, K=K2) would need to be put in the form; list(list(Z=Z1, K=K1),list(Z=Z1, K=K1)), which as can be seen, is a list of lists (2-level list).</p></dd>

  <dt id="arg-r">R<a class="anchor" aria-label="anchor" href="#arg-r"></a></dt>
<dd><p>a list of matrices for residuals, i.e. for longitudinal data. if not passed is assumed an identity matrix.</p></dd>

  <dt id="arg-draw">draw<a class="anchor" aria-label="anchor" href="#arg-draw"></a></dt>
<dd><p>a TRUE/FALSE value indicating if a plot of updated values for the variance components and the likelihood should be drawn or not. The default is TRUE. COMPUTATION TIME IS SMALLER IF YOU DON'T PLOT SETTING draw=FALSE</p></dd>

  <dt id="arg-silent">silent<a class="anchor" aria-label="anchor" href="#arg-silent"></a></dt>
<dd><p>a TRUE/FALSE value indicating if the function should draw the progress bar or iterations performed while working or should not be displayed.</p></dd>

  <dt id="arg-iters">iters<a class="anchor" aria-label="anchor" href="#arg-iters"></a></dt>
<dd><p>a scalar value indicating how many iterations have to be performed if the EM is performed. There is no rule of tumb for the number of iterations. The default value is 100 iterations or EM steps.</p></dd>

    <dt id="arg-constraint">constraint<a class="anchor" aria-label="anchor" href="#arg-constraint"></a></dt>
<dd><p>a TRUE/FALSE value indicating if the program should use the boundary constraint when one or more variance component is close to the zero boundary. The default is TRUE but needs to be used carefully. It works ideally when few variance components are close to the boundary but when there are too many variance components close to zero we highly recommend setting this parameter to FALSE since is more likely to get the right value of the variance components in this way.</p></dd>

      <dt id="arg-init">init<a class="anchor" aria-label="anchor" href="#arg-init"></a></dt>
<dd><p>vector of initial values for the variance components. By default this is NULL and variance components are estimated by the method selected, but in case the user want to provide initial values this argument is functional.</p></dd>

      <dt id="arg-forced">forced<a class="anchor" aria-label="anchor" href="#arg-forced"></a></dt>
<dd><p>a vector of numeric values for variance components including error if the user wants to force the values of the variance components. On the meantime only works for forcing all of them and not a subset of them. The default is NULL, meaning that variance components will be estimated by REML/ML.</p></dd>

      <dt id="arg-tolpar">tolpar<a class="anchor" aria-label="anchor" href="#arg-tolpar"></a></dt>
<dd><p>tolerance parameter for convergence in the models.</p></dd>

      <dt id="arg-tolparinv">tolparinv<a class="anchor" aria-label="anchor" href="#arg-tolparinv"></a></dt>
<dd><p>tolerance parameter for matrix inversion in the models.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This algorithm is based on Searle (1993) and Bernanrdo (2010). This handles models of the form:</p>


<p>y = Xb + Zu + e</p>



<p>b ~ N[b.hat, 0]  ............zero variance because is a fixed term</p>
<p>u ~ N[0, K*sigma(u)]  .......where: K*sigma(u) = G</p>
<p>e ~ N[0, I*sigma(e)]  .......where: I*sigma(e) = R</p>
<p>y ~ N[Xb, var(Zu+e)]   ......where;</p>
<p>var(y) = var(Zu+e) = ZGZ+R = V which is the phenotypic variance</p>
<p>.</p>
<p>The function allows the user to specify the incidence matrices with their respective variance-covariance matrix in a 2 level list structure. For example imagine a mixed model with the following design:</p>
<p>.</p>
<p>fixed = only intercept....................................b ~ N[b.hat, 0]</p>
<p>random = GCA1 + GCA2 + SCA.................u ~ N[0, G]</p>
<p>.</p>
<p>where G is:</p>
<p>.</p>
<p>|K*sigma(gca1).....................0..........................0.........|</p>
<p>|.............0.............S*sigma(gca2).....................0.........| = G
|.............0....................0......................W*sigma(sca)..|</p>
<p>.</p>
<p>The function is based on useing initial values for variance components, i.e.:</p>
<p>.</p>
<p>var(e) &lt;- 100
var(u1) &lt;- 100      with incidence matrix Z1
var(u2) &lt;- 100      with incidence matrix Z2
var(u3) &lt;- 100      with incidence matrix Z3</p>
<p>.</p>
<p>and estimates the lambda(vx) values in the mixed model equations (MME) developed by Henderson (1975), i.e. consider the 3 random effects stated above, the MME are:</p>
<p>.</p>
<p>|...............X'*R*X...............X'*R*Z1.............X'*R*Z2...................X'*R*Z3 ..............|   |...X'Ry...|</p>
<p>|.............Z1'*R*X.........Z1'*R*Z1+K1*v1.....Z1'*R*Z2..................Z1'*R*Z3.............|   |...Z1'Ry...|
|.............Z2'*R*X.............Z2'*R*Z1.............Z2'*R*Z2+K2*v2......Z2'*R*Z3.............|   |...Z2'Ry...|</p>
<p>|.............Z3'*R*X.............Z3'*R*Z1.............Z3'*R*Z2.............Z3'*R*Z3+K3*v3......|   |...Z3'Ry...|
.
..............................................................C.inv...................................................................RHS</p>
<p>.</p>
<p>where "*"" is a matrix product, R is the inverse of the var-cov matrix for the errors, Z1, Z2, Z3 are incidence matrices for random effects, X is the incidence matrix for fixed effects, K1,K2, K3 are the var-cov matrices for random effects and v1,v2,v3 are the estimates of variance components.
.
The algorithm can be summarized in the next steps:
.
1) provide initial values for the variance components
2) estimate the coefficient matrix from MME known as "C"
3) solve the mixed equations as theta = RHS * C.inv
4) obtain new estimates of fixed (b's) and random effects (u's) called theta
5) update values for variance components according to formulas
6) steps are repeated for a number of iterations specified by the user, ideally is enough when no more variations in the estimates is found, in several problems that could take thousands of iterations, whereas in other 10 iterations could be enough.</p>
    </div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If all parameters are correctly indicated the program will return a list with the following information:</p><dl><dt>$var.com</dt>
<dd><p>a vector with the values of the variance components estimated</p></dd>

<dt>$V.inv</dt>
<dd><p>a matrix with the inverse of the phenotypic variance V = ZGZ+R, V^-1</p></dd>

<dt>$u.hat</dt>
<dd><p>a vector with BLUPs for random effects</p></dd>

<dt>$Var.u.hat</dt>
<dd><p>a vector with variances for BLUPs</p></dd>

<dt>$PEV.u.hat</dt>
<dd><p>a vector with predicted error variance for BLUPs</p></dd>

<dt>$beta.hat</dt>
<dd><p>a vector for BLUEs of fixed effects</p></dd>

<dt>$Var.beta.hat</dt>
<dd><p>a vector with variances for BLUEs</p></dd>

<dt>$X</dt>
<dd><p>incidence matrix for fixed effects</p></dd>

<dt>$Z</dt>
<dd><p>incidence matrix for random effects, if not passed is assumed to be a diagonal matrix</p></dd>

<dt>$K</dt>
<dd><p>the var-cov matrix for the random effect fitted in Z</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Covarrubias-Pazaran G (2016) Genome assisted prediction of quantitative traits using the R package sommer. PLoS ONE 11(6): doi:10.1371/journal.pone.0156744</p>
<p>Bernardo Rex. 2010. Breeding for quantitative traits in plants. Second edition. Stemma Press. 390 pp.
Searle. 1993. Applying the EM algorithm to calculating ML and REML estimates of variance components. Paper invited for the 1993 American Statistical Association Meeting, San Francisco.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>The core functions of the package <code><a href="mmer.html">mmer</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">####=========================================####</span></span></span>
<span class="r-in"><span><span class="co">#### For CRAN time limitations most lines in the </span></span></span>
<span class="r-in"><span><span class="co">#### examples are silenced with one '#' mark, </span></span></span>
<span class="r-in"><span><span class="co">#### remove them and run the examples</span></span></span>
<span class="r-in"><span><span class="co">####=========================================####</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ## Import phenotypic data on inbred performance</span></span></span>
<span class="r-in"><span><span class="co"># ## Full data</span></span></span>
<span class="r-in"><span><span class="co"># data("DT_cornhybrids")</span></span></span>
<span class="r-in"><span><span class="co"># hybrid2 &lt;- DT_cornhybrids # extract cross data</span></span></span>
<span class="r-in"><span><span class="co"># A &lt;- GT_cornhybrids # extract the var-cov K</span></span></span>
<span class="r-in"><span><span class="co"># ############################################</span></span></span>
<span class="r-in"><span><span class="co"># ############################################</span></span></span>
<span class="r-in"><span><span class="co"># ## breeding values with 3 variance components</span></span></span>
<span class="r-in"><span><span class="co"># ############################################</span></span></span>
<span class="r-in"><span><span class="co"># ############################################</span></span></span>
<span class="r-in"><span><span class="co"># y &lt;- hybrid2$Yield</span></span></span>
<span class="r-in"><span><span class="co"># X1 &lt;- model.matrix(~ Location, data = hybrid2);dim(X1)</span></span></span>
<span class="r-in"><span><span class="co"># Z1 &lt;- model.matrix(~ GCA1 -1, data = hybrid2);dim(Z1)</span></span></span>
<span class="r-in"><span><span class="co"># Z2 &lt;- model.matrix(~ GCA2 -1, data = hybrid2);dim(Z2)</span></span></span>
<span class="r-in"><span><span class="co"># Z3 &lt;- model.matrix(~ SCA -1, data = hybrid2);dim(Z3)</span></span></span>
<span class="r-in"><span><span class="co"># </span></span></span>
<span class="r-in"><span><span class="co"># K1 &lt;- A[levels(hybrid2$GCA1), levels(hybrid2$GCA1)]; dim(K1)</span></span></span>
<span class="r-in"><span><span class="co"># ## Realized IBS relationships for set of parents 1</span></span></span>
<span class="r-in"><span><span class="co"># K2 &lt;- A[levels(hybrid2$GCA2), levels(hybrid2$GCA2)]; dim(K2)</span></span></span>
<span class="r-in"><span><span class="co"># ## Realized IBS relationships for set of parents 2</span></span></span>
<span class="r-in"><span><span class="co"># S &lt;- kronecker(K1, K2) ; dim(S)</span></span></span>
<span class="r-in"><span><span class="co"># ## Realized IBS relationships for cross (as the Kronecker product of K1 and K2)</span></span></span>
<span class="r-in"><span><span class="co"># rownames(S) &lt;- colnames(S) &lt;- levels(hybrid2$SCA)</span></span></span>
<span class="r-in"><span><span class="co"># </span></span></span>
<span class="r-in"><span><span class="co"># ETA &lt;- list(list(Z=Z1, K=K1), list(Z=Z2, K=K2))#, list(Z=Z3, K=S))</span></span></span>
<span class="r-in"><span><span class="co"># ans &lt;- EM(y=y, ZETA=ETA, iters=50)</span></span></span>
<span class="r-in"><span><span class="co"># ans$var.comp</span></span></span>
<span class="r-in"><span><span class="co"># </span></span></span>
<span class="r-in"><span><span class="co"># # compare with NR method</span></span></span>
<span class="r-in"><span><span class="co"># mix1 &lt;- mmer(Yield~1, random=~vs(GCA1,Gu=K1)+vs(GCA2,Gu=K2), data=hybrid2)</span></span></span>
<span class="r-in"><span><span class="co"># summary(mix1)$varcomp</span></span></span>
<span class="r-in"><span><span class="co"># </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/covaruber" class="external-link">Giovanny Covarrubias-Pazaran</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer></div>





  </body></html>

