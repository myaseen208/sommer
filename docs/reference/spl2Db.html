<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Two-dimensional penalised tensor-product of marginal B-Spline basis. — spl2Db • sommer</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Two-dimensional penalised tensor-product of marginal B-Spline basis. — spl2Db"><meta name="description" content="

Auxiliary function used for modelling the spatial or environmental effect as a two-dimensional penalised tensor-product (isotropic approach) based on Lee et al. (2013) and Rodriguez-Alvarez et al. (2018). spl2Db gets Tensor-Product P-Spline Mixed Model Incidence Matrices
    for use with sommer and its main function mmer. We thank Sue Welham for making the TPSbits package available to the community. If you're using this function for your research please cite her TPSbits package :) this is mostly a wrapper of her tpsmmb function to enable the use in sommer."><meta property="og:description" content="

Auxiliary function used for modelling the spatial or environmental effect as a two-dimensional penalised tensor-product (isotropic approach) based on Lee et al. (2013) and Rodriguez-Alvarez et al. (2018). spl2Db gets Tensor-Product P-Spline Mixed Model Incidence Matrices
    for use with sommer and its main function mmer. We thank Sue Welham for making the TPSbits package available to the community. If you're using this function for your research please cite her TPSbits package :) this is mostly a wrapper of her tpsmmb function to enable the use in sommer."><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116716530-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116716530-2');
</script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sommer</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">4.3.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span> Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-code"></span> Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-file-o"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes"><li><a class="dropdown-item" href="../articles/v1.sommer.quick.start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/v2.sommer.changes.and.faqs.html">FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/v3.sommer.qg.html">Quantitative Genetics</a></li>
    <li><a class="dropdown-item" href="../articles/v4.sommer.gxe.html">GxE models</a></li>
    <li><a class="dropdown-item" href="../articles/v5.sommer.vs.lme4.html">sommer vs lme4</a></li>
    <li><a class="dropdown-item" href="../articles/v6.sommer.spatial.html">Spatial</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="https://github.com/covaruber/sommer" aria-label="GitHub repository"><span class="fa fa-github"></span> GitHub</a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Two-dimensional penalised tensor-product of marginal B-Spline basis.</h1>

      <div class="d-none name"><code>spl2Db.Rd</code></div>
    </div>

    <div class="ref-description section level2">


<p>Auxiliary function used for modelling the spatial or environmental effect as a two-dimensional penalised tensor-product (isotropic approach) based on Lee et al. (2013) and Rodriguez-Alvarez et al. (2018). <code>spl2Db</code> gets Tensor-Product P-Spline Mixed Model Incidence Matrices
    for use with <code>sommer</code> and its main function <code>mmer</code>. We thank Sue Welham for making the TPSbits package available to the community. If you're using this function for your research please cite her TPSbits package :) this is mostly a wrapper of her tpsmmb function to enable the use in sommer.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">spl2Db</span><span class="op">(</span><span class="va">x.coord</span>,<span class="va">y.coord</span>,at.var<span class="op">=</span><span class="cn">NULL</span>,at.levels<span class="op">=</span><span class="cn">NULL</span>,nsegments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, </span>
<span>       degree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, penaltyord <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, nestorder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>       minbound<span class="op">=</span><span class="cn">NULL</span>, maxbound<span class="op">=</span><span class="cn">NULL</span>, method<span class="op">=</span><span class="st">"Lee"</span>, what<span class="op">=</span><span class="st">"bits"</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <p></p>
<dl><dt id="arg-x-coord">x.coord<a class="anchor" aria-label="anchor" href="#arg-x-coord"></a></dt>
<dd><p>vector of coordinates on the x-axis direction (i.e. row) to use in the 2 dimensional spline.</p></dd>

  <dt id="arg-y-coord">y.coord<a class="anchor" aria-label="anchor" href="#arg-y-coord"></a></dt>
<dd><p>vector of coordinates on the y-axis direction (i.e. range or column) to use in the 2 dimensional spline.</p></dd>

  <dt id="arg-at-var">at.var<a class="anchor" aria-label="anchor" href="#arg-at-var"></a></dt>
<dd><p>vector of indication variable where heterogeneous variance is required (e.g., a different spl2D for each field).</p></dd>

  <dt id="arg-at-levels">at.levels<a class="anchor" aria-label="anchor" href="#arg-at-levels"></a></dt>
<dd><p>character vector with the names of the leves for the at term that should be used, if missing all levels are used.</p></dd>

  <dt id="arg-nsegments">nsegments<a class="anchor" aria-label="anchor" href="#arg-nsegments"></a></dt>
<dd><p>numerical vector of length 2 containing the number of segments for each marginal (strictly <code>nsegments</code> - 1 is the number of internal knots in the domain of the covariate). Atomic values are also valid, being recycled. Default set to 10.</p></dd>

  <dt id="arg-degree">degree<a class="anchor" aria-label="anchor" href="#arg-degree"></a></dt>
<dd><p>numerical vector of length 2 containing the order of the polynomial of the B-spline basis for each marginal. Atomic values are also valid, being recycled. Default set to 3 (cubic B-splines).</p></dd>

  <dt id="arg-penaltyord">penaltyord<a class="anchor" aria-label="anchor" href="#arg-penaltyord"></a></dt>
<dd><p>numerical vector of length 2 containing the penalty order for each marginal. Atomic values are also valid, being recycled. Default set to 2 (second order). Currently, only second order penalties are allowed.</p></dd>

  <dt id="arg-nestorder">nestorder<a class="anchor" aria-label="anchor" href="#arg-nestorder"></a></dt>
<dd><p>numerical vector of length 2 containing the divisor of the number of segments (<code>nsegments</code>) to be used for the construction of the nested B-spline basis for the smooth-by-smooth interaction component. In this case, the nested B-spline basis will be constructed assuming a total of <code>nsegments</code>/<code>nestorder</code> segments. Default set to 1, which implies that nested basis are not used. See <code>SAP</code> for more details.</p></dd>

  <dt id="arg-minbound">minbound<a class="anchor" aria-label="anchor" href="#arg-minbound"></a></dt>
<dd><p>A list of length 2. The lower bound to be used for column and row dimensions respectively; default calculated as the minimum value for each dimension.</p></dd>

  <dt id="arg-maxbound">maxbound<a class="anchor" aria-label="anchor" href="#arg-maxbound"></a></dt>
<dd><p>A list of length 2. The upper bound to be used for column and row dimensions respectively; default calculated as the maximum value for each dimension.</p></dd>

  <dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>A string. Method for forming the penalty; default="Lee" ie the penalty from Lee, Durban &amp; Eilers (2013, CSDA 61, 22-37). The alternative method is "Wood" ie. the method from Wood et al (2012, Stat Comp 23, 341-360). This option is a research tool and requires further investigation.</p></dd>

  <dt id="arg-what">what<a class="anchor" aria-label="anchor" href="#arg-what"></a></dt>
<dd><p>one of two values; 'base' or 'bits' to return:</p>
<p>base = matrix for columns cbind(TP.col,TP.row,TP.C.n,TP.R.n,TP.CR.n). To be used in the fixed part.</p>
<p>bits = matrices for the tensor products. To be used in the random part.</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>


<p><strong>The following documentation is taken from the SpATS package. Please refer to this package and associated publications if you are interested in going deeper on this technique:</strong></p>
<p>Within the P-spline framework, anisotropic low-rank tensor-product smoothers have become the general approach for modelling multidimensional surfaces (Eilers and Marx 2003; Wood 2006). In the original SpATS package, was proposed to model the spatial or environmental effect by means of the tensor-product of B-splines basis functions. In other words, was proposed to model the spatial trend as a smooth bivariate surface jointly defined over the the spatial coordinates. Accordingly, the current function has been designed to allow the user to specify the spatial coordinates that the spatial trend is a function of. There is no restriction about how the spatial coordinates shall be specified: these can be the longitude and latitude of the position of the plot on the field or the column and row numbers. The only restriction is that the variables defining the spatial coordinates should be numeric (in contrast to factors).</p>
<p>As far as estimation is concerned, we have used in this package the equivalence between P-splines and linear mixed models (Currie and Durban, 2002). Under this approach, the smoothing parameters are expressed as the ratio between variance components. Moreover, the smooth components are decomposed in two parts: one which is not penalised (and treated as fixed) and one with is penalised (and treated as random). For the two-dimensional case, the mixed model representation leads also to a very interesting decomposition of the penalised part of the bivariate surface in three different components (Lee and Durban, 2011): (a) a component that contains the smooth main effect (smooth trend)	along one of the covariates that the surface is a function of (as, e.g, the x-spatial coordinate or column position of the plot in the field), (b) a component that contains the smooth main effect (smooth trend) along the other covariate (i.e., the y-spatial coordinate or row position); and (c) a smooth interaction component (sum of the linear-by-smooth interaction components and the smooth-by-smooth interaction component).</p>
<p>The default implementation assumes two different smoothing parameters, i.e., one for each covariate in the smooth component. Accordingly, the same smoothing parameters are used for both, the main effects and the smooth interaction. However, this approach can be extended to deal with the ANOVA-type decomposition presented in Lee and Durban (2011). In their approach, four different smoothing parameters are considered for the smooth surface, that are in concordance with the aforementioned decomposition: (a) two smoothing parameter, one for each of the main effects; and (b) two smoothing parameter for the smooth interaction component.</p>
<p>It should be noted that, the computational burden associated with the estimation of the two-dimensional tensor-product smoother might be prohibitive if the dimension of the marginal bases is large. In these cases, Lee et al. (2013) propose to reduce the computational cost by using nested bases. The idea is to reduce the dimension of the marginal bases (and therefore the associated number of parameters to be estimated), but only for the smooth-by-smooth interaction component. As pointed out by the authors, this simplification can be justified by the fact that the main effects would in fact explain most of the structure (or spatial trend) presented in the data, and so a less rich representation of the smooth-by-smooth interaction component could be needed. In order to ensure that the reduced bivariate surface is in fact nested to the model including only the main effects, Lee et al. (2013) show that the number of segments used for the nested basis should be a divisor of the number of segments used in the original basis (<code>nsegments</code> argument). In the present function, the divisor of the number of segments is specified through the argument <code>nestorder</code>. For a more detailed review on this topic, see Lee (2010) and Lee et al. (2013). The "PSANOVA" approach represents an alternative method. In this case, the smooth bivariate surface (or spatial trend) is decomposed in five different components each of them depending on a single smoothing parameter (see Lee et al., 2013).</p>


    </div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>List of length 7 elements:</p><ol><li><p><code>data</code> = the input data frame augmented with structures required
    to fit tensor product splines in <code>asreml-R</code>. This data frame can be used
    to fit the TPS model.</p>
<p>Added columns:</p><ul><li><p><code>TP.col</code>, <code>TP.row</code> = column and row coordinates</p></li>
<li><p><code>TP.CxR</code> = combined index for use with smooth x smooth term</p></li>
<li><p><code>TP.C.n</code> for n=1:(diff.c) = X parts of column spline for use
    in random model (where diff.c is the order of column differencing)</p></li>
<li><p><code>TP.R.n</code> for n=1:(diff.r) = X parts of row spline for use in
    random model (where diff.r is the order of row differencing)</p></li>
<li><p><code>TP.CR.n</code> for n=1:((diff.c*diff.r)) = interaction between the
    two X parts for use in fixed model. The first variate is
    a constant term which should be omitted from the model when the constant
    (1) is present. If all elements are
    included in the model then the constant term should be omitted,
    eg. <code>y ~ -1 + TP.CR.1 + TP.CR.2 + TP.CR.3 + TP.CR.4 + other terms...</code></p></li>
<li><p>when <code>asreml="grp"</code> or <code>"sepgrp"</code>, the spline basis
    functions are also added into the data frame. Column numbers for each
    term are given in the <code>grp</code> list structure.</p></li>
</ul></li>
<li><p><code>fR</code> = Xr1:Zc</p></li>
<li><p><code>fC</code> = Xr2:Zc</p></li>
<li><p><code>fR.C</code> = Zr:Xc1</p></li>
<li><p><code>R.fC</code> = Zr:Xc2</p></li>
<li><p><code>fR.fC</code> = Zc:Zr</p></li>
<li><p><code>all</code> = Xr1:Zc | Xr2:Zc | Zr:Xc1 | Zr:Xc2 | Zc:Zr</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>


<p>Sue Welham (2021). TPSbits: Creates Structures to Enable Fitting and Examination of 2D Tensor-Product Splines using ASReml-R. R package version 1.0.0.</p>
<p>Rodriguez-Alvarez, M.X, Boer, M.P., van Eeuwijk, F.A., and Eilers, P.H.C. (2018). SpATS: Spatial Analysis of Field Trials with Splines. R package version 1.0-9. https://CRAN.R-project.org/package=SpATS.</p>
<p>Rodriguez-Alvarez, M.X., et al. (2015) Fast smoothng parameter separaton n multdmensonal generalzed P-splnes: the SAP algorthm. Statistics and Computing 25.5: 941-957.</p>
<p>Lee, D.-J., Durban, M., and Eilers, P.H.C. (2013). Efficient two-dimensional smoothing with P-spline ANOVA mixed models and nested bases. Computational Statistics and Data Analysis, 61, 22 - 37.</p>
<p>Gilmour, A.R., Cullis, B.R., and Verbyla, A.P. (1997). Accounting for Natural and Extraneous Variation in the Analysis of Field Experiments. Journal of Agricultural, Biological, and Environmental Statistics, 2, 269 - 293.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="mmer.html">mmer</a></code>, <code><a href="spl2Da.html">spl2Da</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## ============================ ##</span></span></span>
<span class="r-in"><span><span class="co">## example to use spl2Db() </span></span></span>
<span class="r-in"><span><span class="co">## ============================ ## </span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">DT_cpdata</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># DT &lt;- DT_cpdata</span></span></span>
<span class="r-in"><span><span class="co"># GT &lt;- GT_cpdata</span></span></span>
<span class="r-in"><span><span class="co"># MP &lt;- MP_cpdata</span></span></span>
<span class="r-in"><span><span class="co"># A &lt;- A.mat(GT)</span></span></span>
<span class="r-in"><span><span class="co"># mix &lt;- mmer(Yield~1,</span></span></span>
<span class="r-in"><span><span class="co">#             random=~vsr(id, Gu=A) +</span></span></span>
<span class="r-in"><span><span class="co">#               vsr(Rowf) +</span></span></span>
<span class="r-in"><span><span class="co">#               vsr(Colf) +</span></span></span>
<span class="r-in"><span><span class="co">#               spl2Db(Row,Col),</span></span></span>
<span class="r-in"><span><span class="co">#             rcov=~units,</span></span></span>
<span class="r-in"><span><span class="co">#             data=DT)</span></span></span>
<span class="r-in"><span><span class="co"># summary(mix)$varcomp</span></span></span>
<span class="r-in"><span><span class="co">## ============================ ##</span></span></span>
<span class="r-in"><span><span class="co">## mimic 2 fields</span></span></span>
<span class="r-in"><span><span class="co">## ============================ ## </span></span></span>
<span class="r-in"><span><span class="co"># aa &lt;- DT; bb &lt;- DT</span></span></span>
<span class="r-in"><span><span class="co"># aa$FIELD &lt;- "A";bb$FIELD &lt;- "B"</span></span></span>
<span class="r-in"><span><span class="co"># set.seed(1234)</span></span></span>
<span class="r-in"><span><span class="co"># aa$Yield &lt;- aa$Yield + rnorm(length(aa$Yield),0,4)</span></span></span>
<span class="r-in"><span><span class="co"># DT2 &lt;- rbind(aa,bb)</span></span></span>
<span class="r-in"><span><span class="co"># head(DT2)</span></span></span>
<span class="r-in"><span><span class="co"># A &lt;- A.mat(GT)</span></span></span>
<span class="r-in"><span><span class="co"># mix &lt;- mmer(Yield~1,</span></span></span>
<span class="r-in"><span><span class="co">#             random=~vsr(dsr(FIELD),id, Gu=A) +</span></span></span>
<span class="r-in"><span><span class="co">#               vsr(dsr(FIELD),Rowf) +</span></span></span>
<span class="r-in"><span><span class="co">#               vsr(dsr(FIELD),Colf) +</span></span></span>
<span class="r-in"><span><span class="co">#                 spl2Db(Row,Col,at.var=FIELD),</span></span></span>
<span class="r-in"><span><span class="co">#             rcov=~vsr(dsr(FIELD),units),</span></span></span>
<span class="r-in"><span><span class="co">#             data=DT2)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/covaruber" class="external-link">Giovanny Covarrubias-Pazaran</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer></div>





  </body></html>

